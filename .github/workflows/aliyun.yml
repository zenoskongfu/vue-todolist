name: Deploy to Aliyun ECS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm install
        
      - name: Build
        run: npm run build
        
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          
      - name: Deploy
        env:
          DEPLOY_PATH: "/var/www/html"  # 部署路径
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
        run: |
          # 添加服务器到已知主机
          ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
          
          # 创建部署目录和时间戳
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          DEPLOY_DIR="${DEPLOY_PATH}/releases/${TIMESTAMP}"
          
          # 在服务器上创建目录
          ssh $DEPLOY_USER@$DEPLOY_HOST "mkdir -p ${DEPLOY_DIR}"
          
          # 上传构建文件
          scp -r dist/* $DEPLOY_USER@$DEPLOY_HOST:${DEPLOY_DIR}/
          
          # 更新软链接
          ssh $DEPLOY_USER@$DEPLOY_HOST "ln -sfn ${DEPLOY_DIR} ${DEPLOY_PATH}/current"
          
          # 清理旧版本（保留最近3个版本）
          ssh $DEPLOY_USER@$DEPLOY_HOST "cd ${DEPLOY_PATH}/releases && ls -t | tail -n +4 | xargs rm -rf"